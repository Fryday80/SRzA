<?php
    $title = 'Dashboard';
    $this->headTitle($title);
/** @var  $dashboardData \Application\Model\DataObjects\DashboardDataCollection*/
$dashboardData = $dashboardData; //cleanfix easier to code

echo '<h1>' . $this->escapeHtml($title) . '</h1>';
?>
<style>
    .dashboard
    {
        text-shadow: none;
    }

    .dashboard-left
    {
        float: left;
        width: 27%;
    }
    .dashboard-right
    {
        float: right;
        width: 67%;
    }
    .dash-list {
        max-height: 200px;
        overflow-y: scroll;
        list-style-type: none
    }
    .dash-list li {
        box-shadow: inset 0px 0px 2vw 0px rgba(41, 0, 0, 0.5);
    }
    @media screen and (max-width: 1350px){
        .dashboard
        {
            width: 100%;
            margin-right: 0;
            float: none !important;
        }
        .dashboard *
        {
        //font-family: normal;
            font-size: 1.5vw !important;
        }

        .dash-list li {
            box-shadow: inset 0px 0px 2vw 0px rgba(41, 0, 0, 0.5);
        }
    }
    @media screen and (max-width: 800px){
        .dashboard
        {
            width: 100%;
            margin-right: 0;
        }
        .dashboard *
        {
            font-family: normal;
            font-size: 3vw !important;
        }

        .dash-list li {
            box-shadow: inset 0px 0px 2vw 0px rgba(41, 0, 0, 0.5);
        }
    }
</style>

<?php

$inside = '';
foreach ($userStats as $stat) $inside .= "<p>$stat[0]: $stat[1]</p>";
echo $this->dashboardHelper()->wrapInBox($inside, 'User Statistics', 'left');
echo $this->dashboardHelper()->render( $dashboardData );
?>
<script type="text/javascript">
    $("[data-timestamp]").each(function() {
        //convert time to nice string and push in ele.html
    })
    //script for live ticks
    function loadLive(e) {
        console.log('update');
        e.fail(function(jqXHR, textStatus, errorThrown) {
            console.log(jqXHR, textStatus, errorThrown);
            //wenns nen error giebt wird fail getriggert nicht done
        });
        e.done(function(e, textStatus, jqXHR) {
            //des hier triggert aber schon oder??glaub nicht... da war ich am schauen
            //dann schau gleich beim richtigen
            console.log(e);
            let actions = JSON.parse(e.actions);
            actions.reverse();
            for(let i = 0; i < actions.length; i++) {
                $('#dashLiveList').prepend("<li class='entry' data-timestamp='" + actions[i].time + "' data-id='" + actions[i].actionID + "'>" + actions[i].msg + "</li>");
            }
            setTimeout(function() {
                let ele =  $('#dashLiveList li:nth-child(1)');
                let since = ele.data('timestamp');
                let actionID = ele.data('id');
                console.log(actionID);
                livereload(since, actionID);
            }, 4500);
        });
    }
    function livereload(since, actionID) {
        let data = {
            method: "getLiveActions",
            since: since,
            actionID: actionID
        };
        $.ajax({
            url: "/system/json",
            type: "POST",
            data: JSON.stringify(data),
            complete: loadLive
        });
    }
    livereload($('#dashLiveList li:nth-child(1)').data('timestamp'), $('#dashLiveList li:nth-child(1)').data('id'));
</script>
