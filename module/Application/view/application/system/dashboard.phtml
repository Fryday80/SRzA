<?php
    $title = 'Dashboard';
    $this->headTitle($title);
/** @var  $dashboardData \Application\Model\StatisticDataCollection*/
$dashboardData = $dashboardData; //cleanfix easier to code

echo '<h1>' . $this->escapeHtml($title) . '</h1>';
?>
<style>
    .new {
        background-color: #58bf83;
    }
    .dashboard
    {
        text-shadow: none;
    }

    .dashboard-left
    {
        float: left;
        width: 27%;
    }
    .dashboard-right
    {
        float: right;
        width: 67%;
    }
    .dash-list {
        max-height: 200px;
        overflow-y: auto;
        list-style-type: none
    }
    boxcontent ul {
        list-style: none;
    }
    .dash-list li {
        box-shadow: inset 0px 0px 2vw 0px rgba(41, 0, 0, 0.5);
    }
    .dashboard
    {
        width: 100%;
        margin-right: 0;
        float: none !important;
    }
    @media screen and (max-width: 1350px){
        .dashboard
        {
            width: 100%;
            margin-right: 0;
            float: none !important;
        }
        .dashboard *
        {
        //font-family: normal;
            font-size: 1.5vw !important;
        }

        .dash-list li {
            box-shadow: inset 0px 0px 2vw 0px rgba(41, 0, 0, 0.5);
        }
    }
    @media screen and (max-width: 800px){
        .dashboard
        {
            width: 100%;
            margin-right: 0;
        }
        .dashboard *
        {
            font-family: normal;
            font-size: 3vw !important;
        }

        .dash-list li {
            box-shadow: inset 0px 0px 2vw 0px rgba(41, 0, 0, 0.5);
        }
    }
</style>

<?php

// ************************************************************************************* USER STATS
$inside = '';
foreach ($userStats as $stat) $inside .= "<li>$stat[0]: $stat[1]</li>";
?>
<box class = 'dashboard dashboard-left'>
    <boxtitel>
        <span class='own_text_small'>User Statistics</span>
    </boxtitel>
    <boxcontent><ul class="dash-list"><?php echo $inside ?></ul></boxcontent>
</box>

<?php
// ************************************************************************************* LIVE CLICKS
$inside = '';
$set = $dashboardData->actionsLogToArray();
/** @var  $item \Application\Model\ActionsLog*/
foreach ( $set as $item )
    if($item !== null) {
        $inside .=
            '<li class="entry basicdata" data-timestamp="' . $item->time . '" data-id="' . $item->actionID . '">' .
            $item->actionType .
            ' @ ' . date('H:i d.m.Y', $item->time) . ': ' .
            $item->title . ': ' .
            $item->msg .
            '</li>';
    }
?>
<box class = 'dashboard dashboard-right'>
    <boxtitel>
        <span class='own_text_small'>Live Clicks</span>
    </boxtitel>
    <boxcontent><ul id="dashLiveList" class="dash-list"><?php echo $inside ?></ul></boxcontent>
</box>

<?php
// ************************************************************************************* ACTIVE USERS
$inside = '';
$set = $dashboardData->getActiveUsers();
/** @var  $item \Application\Model\ActiveUser*/
bdump($item);
foreach ($set as $item) $inside .= "<li>$item->userName: $item->lastActionUrl @ " . date('H:i', $item->time) . "</li>";
bdump($set);
?>
<box class = 'dashboard dashboard-left'>
    <boxtitel>
        <span class='own_text_small'>Active Users</span>
    </boxtitel>
    <boxcontent><ul class="dash-list"><?php echo $inside ?></ul></boxcontent>
</box>

<?php
// ************************************************************************************* SYSTEM LOG
$inside = '';
foreach ($userStats as $stat) $inside .= "<p>Sys: log</p>";
?>
<box class = 'dashboard dashboard-right'>
    <boxtitel>
        <span class='own_text_small'>System Log</span>
    </boxtitel>
    <boxcontent><ul class="dash-list"><?php echo $inside ?></ul></boxcontent>
</box>

<script type="text/javascript">
    $("[data-timestamp]").each(function() {
        //convert time to nice string and push in ele.html
    })
    //script for live ticks
    function loadLive(e) {
        $('.new').removeClass('new');
        console.log('update');
        e.fail(function(jqXHR, textStatus, errorThrown) {
            console.log(jqXHR, textStatus, errorThrown);
            //wenns nen error giebt wird fail getriggert nicht done
        });
        e.done(function(e, textStatus, jqXHR) {
            //des hier triggert aber schon oder??glaub nicht... da war ich am schauen
            //dann schau gleich beim richtigen
            console.log(e);
            let actions = JSON.parse(e.actions);
//            actions.reverse();
            for(let i = 0; i < actions.length; i++) {
                let Hours = Date(actions[i].time).getHours();
                let Minutes = "0" + Date(actions[i].time).getMinutes();
                let actionsTime = Hours + Minutes.substr(-2);
                $('#dashLiveList').prepend("<li class='entry new' data-timestamp='" + actions[i].time + "' data-id='" + actions[i].actionID + "'>" +
                    actions[i].actionType +
                    ' @ ' + actionsTime + ': ' +
                    actions[i].title + ': ' + actions[i].msg + "</li>");
            }
            setTimeout(function() {
                let ele =  $('#dashLiveList li:nth-child(1)');
                let since = ele.data('timestamp');
                let actionID = ele.data('id');
                console.log(actionID);
                livereload(since, actionID);
            }, 4500);
        });
    }
    function livereload(since, actionID) {
        let data = {
            method: "getLiveActions",
            since: since,
            actionID: actionID
        };
        $.ajax({
            url: "/system/json",
            type: "POST",
            data: JSON.stringify(data),
            complete: loadLive
        });
    }
    livereload($('#dashLiveList li:nth-child(1)').data('timestamp'), $('#dashLiveList li:nth-child(1)').data('id'));
</script>
