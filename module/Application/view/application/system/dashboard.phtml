<?php

$title = 'Dashboard';
    $this->headTitle($title);

echo '<h1>' . $this->escapeHtml($title) . '</h1>';
?>
<style>
    @keyframes newOne {
        from {
            box-shadow: inset 0px 0px 2vw 0px rgba(16, 120, 0, 0.65);
        }
        to {
            box-shadow: inset 0px 0px 2vw 0px rgba(41, 0, 0, 0.5);
        }
    }
    .dash-list
    {
        max-height: 200px;
        overflow-y: auto;
        list-style-type: none;
        text-shadow: none;
    }
    .dash-links {
        min-height: 30px;
    }
    .dash-links li{
        display: inline-block;
        padding: 10px;
        box-shadow: inset 0px 0px 2vw 0px rgba(41, 0, 0, 0.5);
        width: 17%;
    }
    .dash-links li:hover,
    .dash-links li:active
    {
        text-shadow: 1px 1px rgba(112, 186, 192, 0.9);
        background-color: rgba(41, 0, 0, 0.5);
        box-shadow: inset 0px 0px 2vw 0px rgba(54, 178, 192, 0.9);
        display: inline-block;
        padding: 10px;
    }
    .dash-links li a {
        width: 100%;
        display: block;
        text-align: center;
    }
    boxcontent ul
    {
        list-style: none;
    }
    .dash-list li
    {
        animation-name: newOne;
        animation-duration: 4s;
        box-shadow: inset 0px 0px 2vw 0px rgba(41, 0, 0, 0.5);
    }
    .dashboard
    {
        width: 100%;
        margin-right: 0;
        float: none !important;
    }
    @media screen and (max-width: 1350px){
        .dashboard
        {
            width: 100%;
            margin-right: 0;
            float: none !important;
        }
        .dashboard *
        {
        //font-family: normal;
            font-size: 1.5vw !important;
        }

        .dash-list li {
            box-shadow: inset 0px 0px 2vw 0px rgba(41, 0, 0, 0.5);
        }
    }
    @media screen and (max-width: 800px){
        .dashboard
        {
            width: 100%;
            margin-right: 0;
        }
        .dashboard *
        {
            font-family: normal;
            font-size: 3vw !important;
        }

        .dash-list li {
            box-shadow: inset 0px 0px 2vw 0px rgba(41, 0, 0, 0.5);
        }
    }
</style>

<?php

function getDataStringFromDataSets( $itemArray ){
    if (!is_array($itemArray)) return null;
    $result = array();
    foreach ($itemArray as $key => $value){
        $firstItem = $key;
        break;
    }
    if ($itemArray[$firstItem] instanceof \Application\Model\ActiveUser){
        /** @var  $item ActiveUser*/
        foreach ($itemArray as $item)
            if ($item !== null) {
                $insideString = '';
                $insideString .= "$item->userName: $item->url <b> @ </b>" . \Application\Controller\SystemController::dateFromMicrotime($item->time);
                array_push($result, array("string" => $insideString));
            }
        return $result;
    }
    if ($itemArray[$firstItem] instanceof \Application\Model\SystemLog) {
        // @todo
        return $result;
    }
    else return null;
}

function getDataStringFromArray($data){
    if (!is_array($data)) return null;
    $result = array();
    $insideString = "<table>";
    $td = "<td style='min-width:8%'>";
    $space = "<td style='width:2%'> <b>||</b> </td>";
    $i = 1;
    foreach ($data as $value)
        if ($value !== null)
            foreach ($value as $k => $v) {
                $insideString .= ($i == 0) ? "<tr>" : "";
                $insideString .= "$td<b>$k:</b></td>$td$v</td>";
                $c = 3;
                $insideString .= ($i == $c) ? "</tr>" : "$space";
                $i++;
                $i = ($i == ($c+1)) ? 0 : $i;
            }
    $insideString .= "</table>";
    array_push($result, array("string" => $insideString));
    return $result;
}
// ************************************************************************************* QUICK LINKS
?>
<box class = 'dashboard dashboard-left'>
    <boxtitel>
        <span class='own_text_small'></span>
    </boxtitel>
    <boxcontent>
        <ul class="dash-links">
            <li><a href='/'> Home</a></li>
            <li><a href='/cms'> Content</a></li>
            <li><a href='/media/filebrowser'> File Browser</a></li>
            <li><a href='/nav/sort'> Navigation</a></li>
            <li><a href='/system/dashboard'> Dashboard Reload</a></li>
        </ul></boxcontent>
</box>

<?php
// ************************************************************************************* USER STATS
$li = '';
$userStats = getDataStringFromArray($userStats);
if($userStats !== null)
    foreach ($userStats as $item) $li .= "<li>" . $item['string'] . "</li>";
?>
<box class = 'dashboard user-stats'>
    <boxtitel>
        <span class='own_text_small'>User Statistics</span>
    </boxtitel>
    <boxcontent><ul class="dash-list"><?php echo $li ?></ul></boxcontent>
</box>

<?php
// ************************************************************************************* LIVE CLICKS
?>
<box class = 'dashboard'>
    <boxtitel>
        <span class='own_text_small'>Live Clicks</span>
    </boxtitel>
    <boxcontent>
        <ul id="dashLiveList" class="dash-list">
            <li class="entry basicdata" data-timestamp="0"></li>
        </ul>
    </boxcontent>
</box>

<?php
// ************************************************************************************* ACTIVE USERS
$li = '';
$activeUsers = getDataStringFromDataSets($activeUsers);
if($activeUsers !== null)
    foreach ( $activeUsers as $item )
        if($item !== null)
            $li .= '<li>' . $item['string'] . '</li>';
?>
<box class = 'dashboard'>
    <boxtitel>
        <span class='own_text_small'>Active Users</span>
    </boxtitel>
    <boxcontent><ul class="dash-list"><?php echo $li ?></ul></boxcontent>
</box>

<?php
// ************************************************************************************* SYSTEM LOG
$li = '';
$sysLog = getDataStringFromDataSets($sysLog);
if($sysLog !== null)
    foreach ( $sysLog as $item )
        if($item !== null)
            $li .= '<li>' . $item['string'] . '</li>';
?>
<box class = 'dashboard'>
    <boxtitel>
        <span class='own_text_small'>System Log</span>
    </boxtitel>
    <boxcontent><ul class="dash-list"><?php echo $li ?></ul></boxcontent>
</box>

<script type="text/javascript">
    //script for live ticks
    function loadLive(e) {

        e.fail(function(jqXHR, textStatus, errorThrown) {
            console.log(jqXHR, textStatus, errorThrown);
        });
        e.done(function(e, textStatus, jqXHR) {
            let actions = e.actions;
            if (actions !== null) {;
//                actions.reverse();

                for (let i = 0; i < actions.length; i++) {
                    $('#dashLiveList').prepend("<li class='entry' data-timestamp='" + actions[i].time + "'>" +
                        actions[i].dateTime + ": " + actions[i].userName + " ...called: " + actions[i].url + "</li>");
                }
            }
            setTimeout(function() {
                let ele =  $('#dashLiveList li:nth-child(1)');
                let since = ele.data('timestamp');
                livereload(since);
            }, 4500);
        });
    }
    function livereload(since) {
        let data = {
            method: "getLiveActions",
            since: since,
        };
        $.ajax({
            url: "/system/json",
            type: "POST",
            data: JSON.stringify(data),
            complete: loadLive
        });
    }
    livereload($('#dashLiveList li:nth-child(1)').data('timestamp'));
</script>
