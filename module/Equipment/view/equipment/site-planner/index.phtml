<?php
$title = $this->translate("Site Planner");
$this->headTitle($title);

// $this->headLink()->prependStylesheet('/libs/jstree/themes/default-dark/style.css');
$this->headScript()->appendFile('/libs/fabric.js/fabric.js');
$this->headScript()->appendFile('/libs/map.js');
// $this->headScript()->appendFile('/libs/jstree/jstree.min.js');

?>
<h1><?php echo $this->escapeHtml($title); ?></h1>
<style>
    #sitePlanner {
        display: flex;
    }
    #sitePlanner .canvas {
        flex-grow: 1;
    }
    #sitePlanner .planner-controls {
        flex: 0 0 200px;
        width: 200px;
        padding: 5px;
    }
    #sitePlanner .planner-controls ul {
        list-style: none;
    }
    #sitePlanner .plan-select {
        float: left;
        width: 120px;
        margin-left: 0px;
    }
    #sitePlanner button.load-plan {
        float: right;
        margin-top: 0px;
    }
    #sitePlanner hr {
        clear:both;
        margin: 10px 0 10px 0;
        padding: 1px 0 1px 0;
        background-color: black;
    }
    #sitePlanner .planner-controls label[for] {
        float: left;
        margin-top: 0px;
    }
    #lon,
    #lat,
    #zoom,
    #scale-select,
    #diameter,
    #maptype-select {
        width: 95px;
        float: right;
    }
    #sitePlanner .setMap {
        margin: 10px 0 10px 0;
        float: right;
        height: 33px;
    }

</style>
<box id="sitePlanner">
    <div class="planner-controls">
        <label>
            <span>Pl√§nne</span>
            <select class="plan-select"></select>
        </label>
        <button class="load-plan"> Load </button>
        <div style="clear:both"></div>
        <label>
            <span>Name</span>
            <input id="plan-name" type="text" placeholder="NAME" style="height: 16px; width: 95px;">
        </label>
        <button class="save-plan">Save</button>
        <button class="new-plan" style="float:right">New</button>
        <hr>
        <label for="lon">Longitude:</label>
        <input id="lon" type="number">
        <br>
        <label for="lat">Latitude:</label>
        <input id="lat" type="number">
        <br>
        <label for="zoom">Zoom:</label>
        <input id="zoom" type="number" min="1" max="7" step="1">
        <br>
        <label for="scale-select">Quality:</label>
        <select id="scale-select"> 
            <option value="1">1</option>
            <option value="2">2</option>
        </select>
        <br>
        <label for="maptype-select">map type:</label>
        <select id="maptype-select">
            <option value="terrain">Terrain</option>
            <option value="satellite">Satellite</option>
            <option value="roadmap">Roadmap</option>
            <option value="hybrid">Hybrid</option>
        </select>
        <label for="diameter">Map size:</label>
        <input id="diameter" type="number" min="1" max="5" step="1">
        <br>
        <div style="clear:both"></div>
        <button class="setMap">Set Map</button>

        <hr>
        <button class="zoomin">ZoomIn</button>
        <button class="zoomout">ZoomOut</button>
        <button class="createImage">Create Image</button>
        <hr>
        <ul class="itemList">
            <?php
            foreach($tents as $tent): ?>
                <li>
                    <span class="type">
                        <?php echo $tent['type'] ?>
                    </span>
                    <span class="user">
                        <?php echo $tent['user_name'] ?>
                    </span>
                </li>
            <?php endforeach; ?>
        </ul>
    </div>
    <div class="canvas">
        <canvas class="site-planner-canvas"><?php echo json_encode($tents); ?></canvas>
    </div>
</box>
<script>
    //site planner
    (function($) {
        "use strict";
        var defaultOptions = {
            color: "#556b2f",
            backgroundColor: "white"
        };

        function loadImage(url, callback) {
            var img = new Image();
            img.onload = callback;
            img.src = url;
        }
        function preloadImages(urls, callback, progress){
            var pointer = 0;
            var images = [];

            function onload() {
                //console.log('image loaded: %s', this.src);
                images.push(this);
                pointer++;
                if (pointer < urls.length) {
                    progress(pointer / urls.length);
                    loadImage(urls[pointer], onload);
                } else {
                    callback(images);
                }
            }
            loadImage(urls[pointer], onload);
        }
        function createGoogleMapStaticImageUrls(options) {
            var result = [];
            var zoom = Math.abs(options.zoom - 7);
            zoom = Math.pow(2, zoom);
            var offlong = zoom * 0.000277;
            var offlat = zoom * 0.000429;
            for (var line = 0; line < options.diameter; line++) {
                for (var pos = 0; pos < options.diameter; pos++) {
                    var center = [
                        Math.floor( (options.longitude - line * offlong) * 1000000  ) / 1000000,
                        Math.floor( (options.latitude + pos * offlat) * 1000000  ) / 1000000,
//                        options.longitude - line * offlong,
//                        options.latitude + pos * offlati,
                    ];
//                    console.log('line: %i  |  pos: %i', line, pos);
//                    console.log(center);
                    var url = $.liveMapLink('AIzaSyDIx0TGGgH1atq7sGFxb3KpnhEnVAFJwxc', {
                        size: '640x640',
                        center: center[0] + ',' + center[1],
                        zoom: 14 + options.zoom,
                        maptype: options.mapType,
                        scale: options.scale,
                    });
                    result.push(url);
                }
            }
            return result;
        }

        var TentEntity = fabric.util.createClass(fabric.Object, {
            type: 'tent',
            radius: 40,
            startAngle: 0,
            endAngle: Math.PI * 2,

            /**
             * Constructor
             * @param {Object} [options] Options object
             * @return {fabric.Circle} thisArg
             */
            initialize: function(tent) {
                this.callSuper('initialize', {
                    tent: tent,
                    left: 100,
                    top: 100,
                    width: parseInt(tent.width) / 5,
                    height: parseInt(tent.length) / 5
                });

                this.setControlsVisibility({
                    bl: false,
                    br: false,
                    mb: false,
                    ml: false,
                    mr: false,
                    mt: false,
                    tl: false,
                    tr: false,
                    mtr: true,
                });
                this.on('deselected', function(e) {
                    this.moveTo(100);
                }.bind(this));
            },
            _render: function(ctx) {
//                ctx.rotate();
                // 0 = eckig
                // 1 = rechteck
                // 2 = sachs
                switch (parseInt(this.tent.shape)) {
                    case 0:
                        ctx.beginPath();
                        ctx.arc(0,
                            0,
                            this.tent.width * 5,
                            this.startAngle,
                            this.endAngle, false);
                        this._renderFill(ctx);
                        this._renderStroke(ctx);
                        break;
                    case 1:
                        var x = -this.width / 2,
                            y = -this.height / 2,
                            w = this.width,
                            h = this.height,
                            cs = 10;//corner size

                        ctx.beginPath();
                        ctx.moveTo(x, y);
                        ctx.lineTo(x + w, y);

                        ctx.lineTo(x + w, y + h);
                        ctx.lineTo(x, y + h);
                        ctx.lineTo(x, y);
//                        ctx.beginPath();
//                        ctx.moveTo(x + cs, y);
//                        ctx.lineTo(x + w - cs, y);
//                        ctx.quadraticCurveTo(x + w, y, x + w, y + cs);
//
//                        ctx.lineTo(x + w, y + h - cs);
//                        ctx.quadraticCurveTo(x + w, y + h, x + w - cs, y + h);
//                        ctx.lineTo(x + cs, y + h);
//                        ctx.quadraticCurveTo(x, y + h , x, y + h - cs);
//                        ctx.lineTo(x, y + cs);
//                        ctx.quadraticCurveTo(x, y, x + cs, y);
                        break;
                }
                ctx.fillStyle = "#ffffff";
                ctx.strokeStyle = "#000000";
                ctx.lineWidth = 2;
                ctx.fill();
                ctx.stroke();
            },
        });


        /**
         * Main class, holds everything together
         */
        class SitePlanner {
            constructor(element, settings) {
                var $canvas = $('.site-planner-canvas', element);
                this.$element = $(element);
                this.progressBarWidth = 250;
                this.viewPos = {x:0, y:0};
                this.zoomValue = 1;
                this.isDragging = false;
                this.data = JSON.parse($canvas.html());
                this.mapImages = [];
                this.items = [];
                this.isBusy = false;
                this.planList = [];
                this.plan = {
                    longitude: 48.249238,
                    latitude: 11.562762,
                    zoom: 7,
                    scale: 2,
                    mapType: 'satellite',
                    diameter: 2,
                };
                //init
                $canvas.html('');
                //create fabric
                this.canvas = new fabric.Canvas($canvas[0], {
                    width: 900,
                    height: 600,
                    backgroundColor : "#000000",
                });
                this.canvas.selection = false;
                fabric.Object.prototype.set({
                    transparentCorners: false,
                    borderColor: '#ff00ff',
                    cornerColor: '#ff0000',
                });
                var progressBarText = new fabric.Text('load map', {
                    left: this.progressBarWidth / 2,
                    top: 0,
                    fill: '#ffffff',
                    fontSize: 12,
                    originX: 'center',
                    originY: 'center'
                });
                this.progressBar = new fabric.Rect({
                    left: 0,
                    top: 20,
                    fill: 'red',
                    width: 50,
                    height: 20,
                });
                var progressBarBorder = new fabric.Rect({
                    left: 0,
                    top: 20,
                    stroke: 'red',
                    width: this.progressBarWidth,
                    height: 20,
                });

                this.progressGroup = new fabric.Group([progressBarText, progressBarBorder, this.progressBar], {
                    left: 300,
                    top: 100,
                    angle: 0
                });

                this.setMap();
//                this.setMap([48.376848, 10.889686]);
                for(var i = 0; i < this.data.length; i++ ) {
                    this.addItem(this.data[i]);
                }
                this.initControls();
            }
            initControls() {
                var self = this;
                this.loadSitePlanList();
                this.updateMapConfig();
                this.canvas.on({
                    'mouse:down': this.mouseDownHandler.bind(this),
                    'mouse:up': this.mouseUpHandler.bind(this),
                    'mouse:move': this.mouseMoveHandler.bind(this),
                    'mouse:over': this.mouseOverHandler.bind(this),
                });

                $('button.load-plan', this.$element).click(function (e) {
                    if (self.isBusy) return;
                    var planID = $('.plan-select', this.$element).val();
                    self.loadSitePlan(planID);
//                    self.writeMapConfig({
//                        longitude: ,
//                        latitude: ,
//                        zoom: ,
//                        scale: ,
//                        mapType:
//                    });
                });
                $('button.save-plan', this.$element).click(function (e) {
                    if (self.isBusy) return;
                    self.savePlan();
                    //@todo save plann
                });
                $('button.new-plan', this.$element).click(function (e) {
                    if (self.isBusy) return;
                    //@todo save plann
                });
                $('button.setMap', this.$element).click(function () {
                    self.readMapConfig();
                    self.setMap();
                });
                
                
                $('button.createImage', this.$element).click(function (e) {
                    if (self.isBusy) return;
                    //@todo create image from canvas and open a new canvas to crop. than upload
                });
                $('button.zoomin', this.$element).click(function (e) {
                    if (self.isBusy) return;
                    self.zoomIn();
                });
                $('button.zoomout', this.$element).click(function (e) {
                    if (self.isBusy) return;
                    self.zoomOut();
                });
            }
            readMapConfig() {
                this.plan.longitude = parseFloat($('#lon').val());
                this.plan.latitude = parseFloat($('#lat').val());
                this.plan.zoom = parseInt($('#zoom').val());
                this.plan.scale = parseInt($('#scale-select').val());
                this.plan.mapType = $('#maptype-select').val();
                this.plan.diameter = parseInt($('#diameter').val());
            }
            updateMapConfig() {
                $('#lon')           .val(this.plan.longitude);
                $('#lat')           .val(this.plan.latitude);
                $('#zoom')          .val(this.plan.zoom);
                $('#scale-select')  .val(this.plan.scale);
                $('#maptype-select').val(this.plan.mapType);
                $('#diameter')      .val(this.plan.diameter);
            }
            hideProgressBar() {
                var self = this;
                setTimeout(function() {
                    self.canvas.remove(self.progressGroup);
                    self.isBusy = false;
                }, 500);
            }
            updateProgressBar(value) {
                var self = this;
                if (typeof value === 'number') {
                    if (value === 0) {
                        //show progress group and set value to 0
                        this.progressBar.set('width', 0);
                        this.canvas.remove(this.progressGroup);
                        this.canvas.add(this.progressGroup);
                    }
                    this.progressBar.animate('width', value * 250, {
                        onChange: this.canvas.renderAll.bind(this.canvas),
                        duration: 200,
                        easing: fabric.util.ease.easeInCirc(),
                        onComplete: function() {
                        },
                        abort: function(){
//                            return true;
                        }
                    });

                    //set progress bar length
                } else if (value === false) {
                    //hide progress element
                }
            }
            setMap() {
                if (this.isBusy) return;
                var self = this;
                this.isBusy = true;
                this.updateProgressBar(0);

                //remove old map images
                for (var i = 0; i < this.mapImages.length; i++) {
                    this.canvas.remove(this.mapImages[i]);
                }
                this.mapImages = [];

                this.setViewPort(0, 0);
                this.zoom(1);
                this.canvas.renderAll();

                //@todo hide items?
                this.showItems(false);
                this.updateItems();

                var urls = createGoogleMapStaticImageUrls(this.plan);
                var createUrlProcess = 0;
                function finish() {
                    self.showItems(true);
                    self.updateProgressBar(1);
                    self.hideProgressBar();
                }
                function createFromUrl(url, line, pos, zIndex) {
                    fabric.Image.fromURL(url, function(img) {
//                        console.log('line: %i  |  pos: %i  |  zIndex: %i', line, pos, zIndex);
//                        console.log(
//                            pos * 640,
//                            line * 640);
                        img.set('isMap', true);
                        img.scale(1 / self.plan.scale).set({
                            left: pos * 640,
                            top: line * 610,
                            scale: 2,
                            selectable: false,
                            originX: 'left',
                            originY: 'top',
                            transparentCorners: false
                        });
                        self.canvas.add(img);
//                        self.canvas.bringToFront(img);
                        self.canvas.moveTo(img, zIndex);
                        self.mapImages.push(img);
                        createUrlProcess++;
                        if (createUrlProcess >= self.plan.diameter) {
                            finish();
                        }
                    });
                }

                preloadImages(urls, function(images) {
                    for (var line = 0; line < self.plan.diameter; line++) {
                        for (var pos = 0; pos < self.plan.diameter; pos++) {
                            createFromUrl(images[line * self.plan.diameter + pos].src, line, pos, -line);
                        }
                    }
                }, function(value) {
                    self.updateProgressBar(value);
                });
            }
            zoom(value) {
                this.zoomValue = Math.max(1, value);
                this.canvas.setZoom(this.zoomValue);
            }
            zoomIn() {
//                this.zoomValue *= 2;
//                this.canvas.setZoom(this.zoomValue);
            }
            zoomOut() {
//                this.zoomValue /= 2;
//                this.canvas.setZoom(this.zoomValue);
            }
            setViewPort(deltax = 0, deltay = 0) {
                this.viewPos.x = deltax;
                this.viewPos.y = deltay;
                this.canvas.absolutePan({
                    x: this.viewPos.x,
                    y: this.viewPos.y
                });
            }
            moveViewPort(deltax = 0, deltay = 0) {
                this.viewPos.x -= deltax;
                this.viewPos.y -= deltay;
                this.canvas.absolutePan({
                    x: this.viewPos.x,
                    y: this.viewPos.y
                });
            }
            addItem(data) {
                var entity = new TentEntity(data);
                this.canvas.add(entity);
                entity.moveTo(100);
                entity.bringToFront();
                this.items.push(entity);
                this.updateItems();
                return entity;
            }
            updateItems() {
                //resize items depending on this.plan.zoom
                for(var i = 0; i < this.items.length; i++) {
                    var z = Math.abs(this.plan.zoom - 7);
                    z = Math.pow(2, z);
                    var item = this.items[i];
                    item.scale(1 / z);
                }
            }
            showItems(flag = true) {
                for(var i = 0; i < this.items.length; i++) {
                    if (flag) {
                        this.canvas.add(this.items[i]);
                    } else {
                        this.items[i].remove();
                    }
                }
            }
            updatePlanList() {
                $('.plan-select', this.$element).empty();
                for(var i = 0; i < this.planList.length; i++) {
                    $('.plan-select', this.$element).append('<option value="' + this.planList[i].id + '">' + this.planList[i].name + '</option>');
                }
            }
            loadSitePlanList() {
                $.getJSON("/siteplanner/list", function(result){
                    //save and update plan list
                    this.planList = result.data;
                    this.updatePlanList();
                }.bind(this));
            }
            loadSitePlan(planID) {
                $.getJSON("/siteplanner/get/" + planID , function(result){
                    console.log(result.data);
                    //--then save list and create list
                });
                //ajax call to load it
                //--then save plan in cache
//                --setMap
                //--setItems
            }
            //save plan
            savePlan() {
                if (this.isBusy) return false;
                this.isBusy = true;
                this.updateProgressBar(0);

                var self = this,
                    data = {
                        id: "1",
                        name: "Plann 1",
                        data: "{}",
                        latitude: "20",
                        longitude: "49",
                    };
                this.ajaxPostJson('/siteplanner/save', data,
                    function (data) {
                    console.log('res', data);
                    self.hideProgressBar();
                }, function (value) {
                    self.updateProgressBar(value);
                });
                return true;
            }
            ajaxPostJson(url, data, success, progress){
                var progressValue = 0.1,
                    progressState = 'Start Loading';

                if (!url) {
                    console.error('url must be set!');
                }
                $.ajax({
                    url: url,
                    type: 'POST',
                    data: JSON.stringify(data),
                    contentType: 'application/json; charset=utf-8',
                    dataType: 'json',
                    success: function(msg) {
                        if (success && typeof success === 'function')
                            success(msg);
                    },
                    xhr: function() {
                        var xhr = new window.XMLHttpRequest();
                        xhr.upload.addEventListener("progress", function(evt) {
                            if (evt.lengthComputable) {
                                progressState = 'Send request';
                                progressValue = (evt.loaded / evt.total) / 2;
                                if (progress)
                                    progress(progressValue, progressState);
                            }
                        }, false);

                        xhr.addEventListener("progress", function(evt) {
                            if (evt.lengthComputable) {
                                progressState = 'Receiving data';
                                progressValue = (evt.loaded / evt.total) / 2 + 0.5;
                                if (progress)
                                    progress(progressValue, progressState);
                            }
                        }, false);

                        return xhr;
                    }
                });
                if (progress)
                    progress(progressValue, progressState);
            }
            mouseDownHandler(e) {
                if (this.isBusy) return;
                if (!e.target || e.target.get('isMap')) {
                    console.log('start drag');
                    this.isDragging = true;
                }
            }
            mouseUpHandler(e) {
                this.isDragging = false;
            }
            mouseMoveHandler(e) {
                if (this.isDragging) {
                    //drag
                    this.moveViewPort(e.e.movementX, e.e.movementY);
                }
            }
            mouseOverHandler(e) {
                if (this.isBusy) return;
            }
        }

        $.fn.SitePlanner = function(options) {
            var settings = $.extend(defaultOptions, options);
            new SitePlanner(this, settings);
        };
    }(jQuery));
    $('#sitePlanner').SitePlanner();
</script>